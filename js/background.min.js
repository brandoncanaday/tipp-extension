!function(){chrome.browserAction.setIcon({path:"img/tipp-icon-btn.svg"});const e="https://tippextension.com",t="AIzaSyDXr947mAu05wahjTLGZ-0ShCtyu2NVm_g",n="1016457967962-mfps991h6u7u6f51aglairp8uho8odnn.apps.googleusercontent.com",r="https://accounts.google.com/o/oauth2/v2/auth?scope=profile+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fyoutube.readonly&include_granted_scopes=true&redirect_uri=https%3A%2F%2F"+chrome.runtime.id+".chromiumapp.org&response_type=token&client_id="+n,o="https://www.googleapis.com/oauth2/v3/tokeninfo",s="https://connect.stripe.com/oauth/authorize?response_type=code&client_id=ca_BZRHiuMtqh9sQR9j0zHNf4bOIhJ3AB4Q&scope=read_write",a={accountCreation:{success:{title:"Account Creation Success",message:"You can now Tipp your favorite videos!"},failure:{title:"Account Creation Failure",message:""}},accountDeletion:{success:{title:"Account Deletion Success",message:"Thank you for using Tipp!"},failure:{title:"Account Deletion Failure",message:"There was an issue deleting your acccount."}},ajaxFailure:{title:"Communication Failure",message:"The connection with Tipp servers failed."},stripeOAuth:{success:{title:"Stripe Connect Success",message:"Your Stripe account was connected!"},failure:{title:"Stripe Connect Failed",message:"Your Stripe account connection failed."}},googleOauthAborted:{title:"Google OAuth Failed",message:"Your YouTube channels were not connected."},mongoFailure:{title:"Database Error",message:"There was an issue communicating with the Tipp database."},illegalAccess:{title:"Illegal Access",message:"Your session has expired. Log back in to do that."},stripeDashboardFailure:{title:"Stripe Dashboard Failure",message:"There was an issue generating your dashboard link."},youtubeConnect:{success:{title:"YouTube Connect Success",message:"You just expanded your Tipp audience!"},failure:{title:"YouTube Connect Failed",message:"There was an issue connecting your account."}},googlePermissionDenied:{title:"Google OAuth Failed",message:"Necessary permissions were not given."},tippAmountError:{title:"Invalid Tipp Amount",message:"You can only Tipp between $1-$100."},stripeCharge:{success:{title:"Tipp Completed",message:""},failure:{title:"Tipp Failed",message:"There was an issue completing your Tipp."}}};function i(e){return m(a.ajaxFailure.title,a.ajaxFailure.message),e({error:{type:"ajax",msg:"Communication with the server failed."}})}function c(e,t,n){return e?(m(a.googleOauthAborted.title,a.googleOauthAborted.message),t(n||{})):(m(a.googlePermissionDenied.title,a.googlePermissionDenied.message),t(n||{}))}function u(e,t){return m(a.youtubeConnect.failure.title,a.youtubeConnect.failure.message),e(t||{})}function p(e,t){return m(a.stripeOAuth.failure.title,a.stripeOAuth.failure.message),e(t||{})}function l(e,t){return m(a.mongoFailure.title,a.mongoFailure.message),e(t||{})}function h(e,t){return m(a.illegalAccess.title,a.illegalAccess.message),g("tipp_account",{}),chrome.browserAction.setPopup({popup:"splash.html"}),e(t||{})}function m(e,t,n){chrome.notifications.create({type:"basic",requireInteraction:!0,isClickable:!0,iconUrl:n||"img/tipp_48x48.png",title:e,message:t})}function d(){const e=f("tipp_account");return e?e.jwt:""}function g(e,t){localStorage.setItem(e,JSON.stringify(t))}function f(e){return JSON.parse(localStorage.getItem(e)?localStorage.getItem(e):"{}")}function y(e,t){t||(t=window.location.href),e=e.replace(/[[\]]/g,"\\$&");let n=new RegExp("[#?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null}chrome.runtime.onMessage.addListener(function(T,b,w){switch(T.message){case"displayname_availability":return function(t,n){const r=Object.keys(t)[0],o=t[r];$.ajax({type:"GET",url:`${e}/api/user/${r}-${o}`,contentType:"application/json",success:e=>{e.error?n({error:e.error}):n({exists:e.exists})},error:()=>{n({error:{type:"ajax",msg:"There was an issue communicating with the Tipp servers."}})}})}({displayname:T.data.displayname},w),!0;case"reset_passphrase":return function(t,n){$.ajax({type:"POST",url:`${e}/api/passphrase-reset-email`,data:JSON.stringify({email:t}),contentType:"application/json",success:e=>{e.error||m("Reset Link Sent","Check your inbox for an email from us!"),n(e)},error:()=>{i(n)}})}(T.email,w),!0;case"is_logged_in":return w({loggedIn:function(){const e=f("tipp_account");return!(!e||!e.jwt)}()}),!0;case"create_user":return function(t,n){!function(t,n,r){$.ajax({type:"POST",url:`${e}/api/create-user`,data:JSON.stringify(t),contentType:"application/json",success:e=>{e.error?"user_exists"==e.error.type?n(e):l(n,e):r(e.user)},error:()=>{i(n)}})}(t,n,e=>{g("tipp_account",e),function(e,t){m(a.accountCreation.success.title,a.accountCreation.success.message),chrome.browserAction.setPopup({popup:"dashboard.html"}),e(t||{})}(n)})}(T.data,w),!0;case"delete_user":return function(t){!function(t,n){$.ajax({type:"POST",url:`${e}/api/auth/delete-user`,contentType:"application/json",headers:{Authorization:`Bearer ${d()}`},success:e=>{e.error?"forbidden"==e.error.type?h(t,e):function(e,t){m(a.accountDeletion.failure.title,a.accountDeletion.failure.message),e(t||{})}(t,e):n()},error:()=>{i(t)}})}(t,()=>{!function(e,t){m(a.accountDeletion.success.title,a.accountDeletion.success.message),g("tipp_account",{}),chrome.browserAction.setPopup({popup:"splash.html"}),e(t||{})}(t)})}(w),!0;case"login_user":return function(t,n,r){$.ajax({type:"POST",url:`${e}/api/login`,data:JSON.stringify({email:t,passphrase:n}),contentType:"application/json",success:e=>{e.error?r(e):(g("tipp_account",e.user),chrome.browserAction.setPopup({popup:"dashboard.html"}),r({}))},error:()=>{r({error:{type:"backend",msg:"There was an issue communicating with the Tipp servers."}})}})}(T.email,T.passphrase,w),!0;case"start_stripe_oauth":return function(t){chrome.identity.launchWebAuthFlow({url:s,interactive:!0},n=>{if(chrome.runtime.lastError)return p(t);const r=y("code",n);if(!r)return p(t);!function(t,n,r){$.ajax({type:"GET",url:`${e}/api/auth/stripe-token/${t}`,contentType:"application/json",headers:{Authorization:`Bearer ${d()}`},success:e=>{if(e.error)"forbidden"==e.error.type?h(n,e):p(n);else{const t=JSON.parse(e.authToken);r(t)}},error:()=>{i(n)}})}(r,t,n=>{!function(t,n,r){$.ajax({type:"POST",url:`${e}/api/auth/update-user`,data:JSON.stringify({fields:t}),contentType:"application/json",headers:{Authorization:`Bearer ${d()}`},success:e=>{e.error?"forbidden"==e.error.type?h(n,e):l(n,e):r()},error:()=>{i(n)}})}({stripe:n},t,()=>{const e=f("tipp_account");e.stripe=!0,g("tipp_account",e),function(e,t){m(a.stripeOAuth.success.title,a.stripeOAuth.success.message),e(t||{})}(t)})})})}(w),!0;case"start_youtube_connect_flow":return function(t){chrome.identity.launchWebAuthFlow({url:r,interactive:!0},r=>{if(chrome.runtime.lastError)return c(!0,t);let s=y("access_token",r);if(!s)return c(!1,t);!function(e,t,r){$.ajax({type:"GET",url:`${o}?access_token=${e}`,success:e=>{e.error||e.aud!=n?u(t):r()},error:()=>{u(t)}})}(s,t,()=>{!function(e,t,n){$.ajax({type:"GET",url:`https://www.googleapis.com/youtube/v3/channels?part=snippet&mine=true&access_token=${e}`,success:e=>{e.error?u(t):n(e)},error:()=>{u(t)}})}(s,t,n=>{let r=function(e){const t=[];return e.forEach(e=>{t.push({channelId:e.id,channelName:e.snippet.title,channelIcon:e.snippet.thumbnails.default.url})}),t}(n.items);r.length?function(t,n,r){$.ajax({type:"POST",url:`${e}/api/auth/add-channels`,data:JSON.stringify(t),contentType:"application/json",headers:{Authorization:`Bearer ${d()}`},success:e=>{e.error?"nothing_inserted"==e.error.type?function(e,t){m(a.youtubeConnect.failure.title,"All channels for this account have been added."),e(t||{})}(n):"forbidden"==e.error.type?h(n,e):l(n,e):r(e.numAdded)},error:()=>{i(n)}})}(r,t,e=>{m(a.youtubeConnect.success.title,e>1?`${e} channels were just connected.`:`${e} channel was just connected.`);const n=f("tipp_account");n.channels=n.channels.concat(r),g("tipp_account",n),t({})}):function(e,t){m(a.youtubeConnect.failure.title,"No channels associated with that account."),e(t||{})}(t)})})})}(w),!0;case"open_stripe_dashboard":return function(e){t="https://dashboard.stripe.com",n=e,chrome.tabs.create({url:t,active:!0},()=>{n({})});var t,n}(w),!0;case"get_stripe_user_from_YT_video":return function(n,r){!function(e,n,r){$.ajax({type:"GET",url:`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${e}&key=${t}`,success:e=>{if(e.error)u(n);else{let t=e.items[0].snippet.channelId;r(t)}},error:()=>{u(n)}})}(n,r,t=>{!function(t,n,r){$.ajax({type:"GET",url:`${e}/api/stripe-id/${t}`,contentType:"application/json",success:e=>{!e.error&&e.stripeId?r(e):e.error?l(n,e):n({})},error:()=>{i(n)}})}(t,r,e=>{r({stripeId:e.stripeId,fname:e.fname,lname:e.lname,displayname:e.displayname})})})}(T.video,w),!0;case"perform_tipp":return function(t,n){!function(t,n,r){$.ajax({type:"POST",url:`${e}/api/auth/charge-card`,data:JSON.stringify({token:t.token,amount:t.amount,destination:t.destination,fname:t.fname,lname:t.lname,displayname:t.displayname}),contentType:"application/json",headers:{Authorization:`Bearer ${d()}`},success:e=>{e.error?"forbidden"==e.error.type?h(n,e):function(e,t){"amount"==e.type?m("Invalid Tipp Amount",e.msg):m("Stripe Charge Failed",e.msg);t({})}(e.error,n):r(e.chargeAmount)},error:()=>{i(n)}})}(t,n,e=>{!function(e,t,n){m(a.stripeCharge.success.title,`Your $${(parseInt(e)/100).toFixed(2)} Tipp was successful!`),t(n||{})}(e,n)})}(T.data,w),!0;default:console.log("message not recognized")}})}();
