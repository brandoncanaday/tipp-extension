!function(){const e="https://tippextension.com",t="AIzaSyDXr947mAu05wahjTLGZ-0ShCtyu2NVm_g",r="1016457967962-mfps991h6u7u6f51aglairp8uho8odnn.apps.googleusercontent.com",n="https://accounts.google.com/o/oauth2/v2/auth?scope=profile+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fyoutube.readonly&include_granted_scopes=true&redirect_uri=https%3A%2F%2F"+chrome.runtime.id+".chromiumapp.org&response_type=token&client_id="+r,o="https://www.googleapis.com/oauth2/v3/tokeninfo",a="https://connect.stripe.com/express/oauth/authorize?redirect_uri=https%3A%2F%2F"+chrome.runtime.id+".chromiumapp.org&client_id=ca_BZRHiuMtqh9sQR9j0zHNf4bOIhJ3AB4Q",s={accountCreation:{success:{title:"Account Creation Success",message:"You can now Tipp your favorite videos!"},failure:{title:"Account Creation Failure",message:""}},accountDeletion:{success:{title:"Account Deletion Success",message:"Thank you for using Tipp!"},failure:{title:"Account Deletion Failure",message:"There was an issue deleting your acccount."}},ajaxFailure:{title:"Communication Failure",message:"The connection with Tipp servers failed."},stripeOAuth:{success:{title:"Stripe Connect Success",message:"Your Stripe account was connected!"},failure:{title:"Stripe Connect Failed",message:"Your Stripe account connection failed."}},googleOauthAborted:{title:"Google OAuth Failed",message:"Your YouTube channels were not connected."},mongoFailure:{title:"Database Error",message:"There was an issue communicating with the Tipp database."},illegalAccess:{title:"Illegal Access",message:"Your session has expired. Log back in to do that."},stripeDashboardFailure:{title:"Stripe Dashboard Failure",message:"There was an issue generating your dashboard link."},youtubeConnect:{success:{title:"YouTube Connect Success",message:"You just expanded your Tipp audience!"},failure:{title:"YouTube Connect Failed",message:"There was an issue connecting your account."}},googlePermissionDenied:{title:"Google OAuth Failed",message:"Necessary permissions were not given."},tippAmountError:{title:"Invalid Tipp Amount",message:"You can only Tipp between $1-$100."},stripeCharge:{success:{title:"Tipp Completed",message:""},failure:{title:"Tipp Failed",message:"There was an issue completing your Tipp."}}};function i(e){return m(s.ajaxFailure.title,s.ajaxFailure.message),e({error:{type:"ajax",msg:"Communication with the server failed."}})}function c(e,t,r){return e?(m(s.googleOauthAborted.title,s.googleOauthAborted.message),t(r||{})):(m(s.googlePermissionDenied.title,s.googlePermissionDenied.message),t(r||{}))}function u(e,t){return m(s.youtubeConnect.failure.title,s.youtubeConnect.failure.message),e(t||{})}function p(e,t){return m(s.stripeOAuth.failure.title,s.stripeOAuth.failure.message),e(t||{})}function l(e,t){return m(s.mongoFailure.title,s.mongoFailure.message),e(t||{})}function h(e,t){return m(s.illegalAccess.title,s.illegalAccess.message),g("tipp_account",{}),chrome.browserAction.setPopup({popup:"splash.html"}),e(t||{})}function m(e,t,r){chrome.notifications.create({type:"basic",requireInteraction:!0,isClickable:!0,iconUrl:r||"img/tipp_48x48.png",title:e,message:t})}function d(){const e=f("tipp_account");return e?e.jwt:""}function g(e,t){localStorage.setItem(e,JSON.stringify(t))}function f(e){return JSON.parse(localStorage.getItem(e)?localStorage.getItem(e):"{}")}function y(e,t){t||(t=window.location.href),e=e.replace(/[[\]]/g,"\\$&");let r=new RegExp("[#?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return r?r[2]?decodeURIComponent(r[2].replace(/\+/g," ")):"":null}chrome.runtime.onMessage.addListener(function(T,b,w){switch(T.message){case"displayname_availability":return function(t,r){const n=Object.keys(t)[0],o=t[n];$.ajax({type:"GET",url:`${e}/api/user/${n}-${o}`,contentType:"application/json",success:e=>{e.error?r({error:e.error}):r({exists:e.exists})},error:()=>{r({error:{type:"ajax",msg:"There was an issue communicating with the Tipp servers."}})}})}({displayname:T.data.displayname},w),!0;case"reset_passphrase":return function(t,r){$.ajax({type:"POST",url:`${e}/api/passphrase-reset-email`,data:JSON.stringify({email:t}),contentType:"application/json",success:e=>{e.error||m("Reset Link Sent","Check your inbox for an email from us!"),r(e)},error:()=>{i(r)}})}(T.email,w),!0;case"is_logged_in":return w({loggedIn:function(){const e=f("tipp_account");return!(!e||!e.jwt)}()}),!0;case"create_user":return function(t,r){!function(t,r,n){$.ajax({type:"POST",url:`${e}/api/create-user`,data:JSON.stringify(t),contentType:"application/json",success:e=>{e.error?"user_exists"==e.error.type?r(e):l(r,e):n(e.user)},error:()=>{i(r)}})}(t,r,e=>{g("tipp_account",e),function(e,t){m(s.accountCreation.success.title,s.accountCreation.success.message),chrome.browserAction.setPopup({popup:"dashboard.html"}),e(t||{})}(r)})}(T.data,w),!0;case"delete_user":return function(t){!function(t,r){$.ajax({type:"POST",url:`${e}/api/auth/delete-user`,contentType:"application/json",headers:{Authorization:`Bearer ${d()}`},success:e=>{e.error?"forbidden"==e.error.type?h(t,e):function(e,t){m(s.accountDeletion.failure.title,s.accountDeletion.failure.message),e(t||{})}(t,e):r()},error:()=>{i(t)}})}(t,()=>{!function(e,t){m(s.accountDeletion.success.title,s.accountDeletion.success.message),g("tipp_account",{}),chrome.browserAction.setPopup({popup:"splash.html"}),e(t||{})}(t)})}(w),!0;case"login_user":return function(t,r,n){$.ajax({type:"POST",url:`${e}/api/login`,data:JSON.stringify({email:t,passphrase:r}),contentType:"application/json",success:e=>{e.error?n(e):(g("tipp_account",e.user),chrome.browserAction.setPopup({popup:"dashboard.html"}),n({}))},error:()=>{n({error:{type:"backend",msg:"There was an issue communicating with the Tipp servers."}})}})}(T.email,T.passphrase,w),!0;case"start_stripe_oauth":return function(t){chrome.identity.launchWebAuthFlow({url:a,interactive:!0},r=>{if(chrome.runtime.lastError)return p(t);const n=y("code",r);if(!n)return p(t);!function(t,r,n){$.ajax({type:"GET",url:`${e}/api/auth/stripe-token/${t}`,contentType:"application/json",headers:{Authorization:`Bearer ${d()}`},success:e=>{if(e.error)"forbidden"==e.error.type?h(r,e):p(r);else{const t=JSON.parse(e.authToken);n(t)}},error:()=>{i(r)}})}(n,t,r=>{!function(t,r,n){$.ajax({type:"POST",url:`${e}/api/auth/update-user`,data:JSON.stringify({fields:t}),contentType:"application/json",headers:{Authorization:`Bearer ${d()}`},success:e=>{e.error?"forbidden"==e.error.type?h(r,e):l(r,e):n()},error:()=>{i(r)}})}({stripe:r},t,()=>{const e=f("tipp_account");e.stripe=!0,g("tipp_account",e),function(e,t){m(s.stripeOAuth.success.title,s.stripeOAuth.success.message),e(t||{})}(t)})})})}(w),!0;case"start_youtube_connect_flow":return function(t){chrome.identity.launchWebAuthFlow({url:n,interactive:!0},n=>{if(chrome.runtime.lastError)return c(!0,t);let a=y("access_token",n);if(!a)return c(!1,t);!function(e,t,n){$.ajax({type:"GET",url:`${o}?access_token=${e}`,success:e=>{e.error||e.aud!=r?u(t):n()},error:()=>{u(t)}})}(a,t,()=>{!function(e,t,r){$.ajax({type:"GET",url:`https://www.googleapis.com/youtube/v3/channels?part=snippet&mine=true&access_token=${e}`,success:e=>{e.error?u(t):r(e)},error:()=>{u(t)}})}(a,t,r=>{let n=function(e){const t=[];return e.forEach(e=>{t.push({channelId:e.id,channelName:e.snippet.title,channelIcon:e.snippet.thumbnails.default.url})}),t}(r.items);n.length?function(t,r,n){$.ajax({type:"POST",url:`${e}/api/auth/add-channels`,data:JSON.stringify(t),contentType:"application/json",headers:{Authorization:`Bearer ${d()}`},success:e=>{e.error?"nothing_inserted"==e.error.type?function(e,t){m(s.youtubeConnect.failure.title,"All channels for this account have been added."),e(t||{})}(r):"forbidden"==e.error.type?h(r,e):l(r,e):n(e.numAdded)},error:()=>{i(r)}})}(n,t,e=>{m(s.youtubeConnect.success.title,e>1?`${e} channels were just connected.`:`${e} channel was just connected.`);const r=f("tipp_account");r.channels=r.channels.concat(n),g("tipp_account",r),t({})}):function(e,t){m(s.youtubeConnect.failure.title,"No channels associated with that account."),e(t||{})}(t)})})})}(w),!0;case"open_stripe_dashboard":return function(t){$.ajax({type:"GET",url:`${e}/api/auth/stripe-dashboard`,headers:{Authorization:`Bearer ${d()}`},success:e=>{e.error?"forbidden"==e.error.type?h(t,e):function(e,t){m(s.stripeDashboardFailure.title,s.stripeDashboardFailure.message),e(t||{})}(t,e):(r=e.link.url,n=t,chrome.tabs.create({url:r,active:!0},()=>{n({})}))},error:()=>{i(t)}});var r,n}(w),!0;case"get_stripe_user_from_YT_video":return function(r,n){!function(e,r,n){$.ajax({type:"GET",url:`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${e}&key=${t}`,success:e=>{if(e.error)u(r);else{let t=e.items[0].snippet.channelId;n(t)}},error:()=>{u(r)}})}(r,n,t=>{!function(t,r,n){$.ajax({type:"GET",url:`${e}/api/stripe-id/${t}`,contentType:"application/json",success:e=>{!e.error&&e.stripeId?n(e):e.error?l(r,e):r({})},error:()=>{i(r)}})}(t,n,e=>{n({stripeId:e.stripeId,fname:e.fname,lname:e.lname,displayname:e.displayname})})})}(T.video,w),!0;case"perform_tipp":return function(t,r){!function(t,r,n){$.ajax({type:"POST",url:`${e}/api/auth/charge-card`,data:JSON.stringify({token:t.token,amount:t.amount,destination:t.destination,fname:t.fname,lname:t.lname,displayname:t.displayname}),contentType:"application/json",headers:{Authorization:`Bearer ${d()}`},success:e=>{e.error?"forbidden"==e.error.type?h(r,e):function(e,t){"amount"==e.type?m("Invalid Tipp Amount",e.msg):m("Stripe Charge Failed",e.msg);t({})}(e.error,r):n(e.chargeAmount)},error:()=>{i(r)}})}(t,r,e=>{!function(e,t,r){m(s.stripeCharge.success.title,`Your $${(parseInt(e)/100).toFixed(2)} Tipp was successful!`),t(r||{})}(e,r)})}(T.data,w),!0;default:console.log("message not recognized")}})}();
